pipeline{
    agent any
    environment{
        PROJECT_PATH = "WebAPI_Test_Project/WebAPI_Test_Project/WebAPI_Test_Project.csproj"
        BUILD_CONFIG = "Release"
        ARTIFACTS_DIR  = "publish"
        REGISTRY_CREDENTIALS = "WebApi_AccessKeys"
        ACCOUNT_ID = "322276017193"
        IMAGE_NAME = "webapirepo"
        ECR_REGISTRY = "322276017193.dkr.ecr.us-east-1.amazonaws.com"
        ECR_REGISTRY_URL = "https://322276017193.dkr.ecr.us-east-1.amazonaws.com"
        FULL_IMAGE = "322276017193.dkr.ecr.us-east-1.amazonaws.com/webapirepo"
        ECS_CLUSTER = "WebAPI_Cluster"
        ECS_SERVICE = "WebApi_Task-service"

    }
    stages{
        stage("checkout Code"){
            steps{
                git url: "https://github.com/YannickGongue/WebAppI.git",
                    branch: "main"
            }
        }
        stage("Check .Net Version"){
            steps{
                sh "dotnet --version"
            }
        }
        stage("Restore Dependencies"){
            steps{
                sh "dotnet restore ${PROJECT_PATH}"
            }
        }
        stage ("Build Application"){
            steps{
                sh "dotnet build ${PROJECT_PATH} -c ${BUILD_CONFIG}"
            }
        }
        stage("Run Test"){
            steps{
                    sh "echo 'No tests configured yet'"
            }
        }
        stage("Build Artifact"){
            steps{
                   sh "dotnet publish ${PROJECT_PATH} -c ${BUILD_CONFIG} -o ${ARTIFACTS_DIR}"
            }
        }
        stage("archive Build output"){
            steps{
                   archiveArtifacts artifacts: "${ARTIFACTS_DIR}/**", allowEmptyArchive: false
            }
        }
        stage('Build Docker Image'){
            steps {
                script {
                    dockerImage = docker.build(
                        "${FULL_IMAGE}:${BUILD_NUMBER}",
                        " -f WebAPI_Test_Project/WebAPI_Test_Project/Dockerfile WebAPI_Test_Project/WebAPI_Test_Project"
                    )
                }
            }
        }
        stage("Login to ECR") {
           steps {
                   withCredentials([[
                   $class: 'AmazonWebServicesCredentialsBinding',
                   credentialsId: "${REGISTRY_CREDENTIALS}",
                  ]]) 
                  {
                    sh """
                       aws ecr get-login-password --region us-east-1 | \
                       docker login --username AWS --password-stdin ${ECR_REGISTRY}
                      """
             }
          }
         }

        stage('Upload App Image to ECR') {
          steps {
             script {
                   dockerImage.push("${BUILD_NUMBER}")
                   dockerImage.push("latest")
             }
          } 
        }
   
       stage('Remove Container Images'){
            steps{
                sh 'docker rmi -f $(docker images -a -q)'
            }
        }
        stage('Deploy to ecs') {
          steps {
            withAWS(credentials: "${REGISTRY_CREDENTIALS}", region: 'us-east-1') {
            sh 'aws ecs update-service --ECS_CLUSTER ${cluECS_CLUSTERster} --ECS_SERVICE ${ECS_SERVICE} --force-new-deployment'
               }
          }
        }

        stage("Hello") {
            steps {
                sh 'echo "My first real Jenkins pipeline for .NET! üöÄ"'
            }
        }
    }
      post {
        success {
            echo "‚úÖ Pipeline SUCCESS"
        }
        failure {
            echo "‚ùå Pipeline FAILED"
        }
    }
}
